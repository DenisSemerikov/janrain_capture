<?php

/**
 * @file
 *
 * This module implements UI elements for Janrain Capture
 *
 * @see http://www.janrain.com/products/capture
 */

$janrain_capture_main = variable_get('janrain_capture_main', array());
$janrain_capture_optional = variable_get('janrain_capture_optional', array());
if (!empty($janrain_capture_main['capture_address']) && !empty($janrain_capture_main['capture_client_id'])) {
  define('CAPTURE_LOGIN_URL', 'https://'
      . (!empty($janrain_capture_optional['captureui_address']) ? $janrain_capture_optional['captureui_address'] : $janrain_capture_main['capture_address'])
      . '/oauth/signin?response_type=code&flags=stay_in_window&recover_password_callback=CAPTURE.closeRecoverPassword&redirect_uri='
      . urlencode(url('janrain_capture/oauth', array('absolute' => true)))
      . '&client_id='
      . $janrain_capture_main['capture_client_id']
      . '&xd_receiver='
      . urlencode(url(null, array('absolute' => true)) . drupal_get_path('module', 'janrain_capture') . '/xdcomm.html'));
}

/**
 * Implementation of hook_init()
 */
function janrain_capture_ui_init() {
  global $user;

  $janrain_capture_main = variable_get('janrain_capture_main', array());
  $janrain_capture_optional = variable_get('janrain_capture_optional', array());
  $janrain_capture_dependencies = variable_get('janrain_capture_dependencies', array());
  
  $capture_sso_address = !empty($janrain_capture_optional['capture_sso_address'])
    ? $janrain_capture_optional['capture_sso_address'] : '';
  $capture_client_id = !empty($janrain_capture_main['capture_client_id'])
    ? $janrain_capture_main['capture_client_id'] : '';

  $scripts = array('module' => array(), 'inline' => array());
  $scripts['module'][] = !empty($janrain_capture_dependencies['capture_json2'])
    ? $janrain_capture_dependencies['capture_json2']
    : 'sites/all/libraries/json2/json2.js';
  $scripts['module'][] = !empty($janrain_capture_dependencies['capture_fancy_js'])
    ? $janrain_capture_dependencies['capture_fancy_js']
    : 'sites/all/libraries/fancybox/jquery.fancybox-1.3.4.pack.js';
  $path = isset($_GET['q']) ? $_GET['q'] : '<front>';
  $link = url($path, array('absolute' => TRUE));
  $uri_opts = array('query' => array('origin' => urlencode($link)), 'absolute' => true);
  $scripts['inline'][] = 'var CAPTURE = {
  resize: function(jargs) {
    var args = JSON.parse(jargs);

    jQuery("#fancybox-inner, #fancybox-wrap, #fancybox-content, #fancybox-frame")
      .css({
        width: args.w, 
        height: args.h
      });

    jQuery.fancybox.resize();
    jQuery.fancybox.center();
  },
  closeProfileEditor: function() {
    window.location.href = "' . url('janrain_capture/profile_sync', $uri_opts) . '";
  },
  closeRecoverPassword: function() {
    window.location.reload();
  },
  token_expired: function() {
    window.location.href = "' . url('janrain_capture/token_expired') . '";
  },
  bp_ready: function() {
    var channelId = encodeURIComponent(Backplane.getChannelID());
    jQuery("a.janrain_capture_signin").each(function(){
      jQuery(this).attr("href", jQuery(this).attr("href") + "&bp_channel=" + channelId).click(function(){
        Backplane.expectMessages("identity/login");
      });
    });
  }
};';
  $scripts['inline'][] = 'jQuery(function($) {
  $(".fancy").fancybox({
    padding: 0,
    scrolling: "no",
    autoScale: true,
    width: 666,
    autoDimensions: false
  });
});';

  $styles = array();
  $styles[] = !empty($janrain_capture_dependencies['capture_fancy_css'])
    ? $janrain_capture_dependencies['capture_fancy_css']
    : 'sites/all/libraries/fancybox/jquery.fancybox-1.3.4.css';

  if (!empty($capture_sso_address)) {
    $scripts['inline'][] = 'JANRAIN.SSO.CAPTURE.check_login({
  sso_server: "https://' . $capture_sso_address . '",
  client_id: "' . $capture_client_id . '",
  redirect_uri: "' . url('janrain_capture/oauth', array('query' => array('from_sso' => 'true'), 'absolute' => true)) . '",
  logout_uri: "' . url('logout', array('absolute' => true)) . '",
  xd_receiver: "' . url(null, array('absolute' => true)) . drupal_get_path('module', 'janrain_capture') . '/xdcomm.html"
});
function janrain_capture_logout() {
  JANRAIN.SSO.CAPTURE.logout({
    sso_server: "https://' . $capture_sso_address . '",
    logout_uri: "' . url('logout', array('absolute' => true)) . '"
  });
}
jQuery(function($) {
    $(".menu li a[href=\'' . url('logout') . '\']").click(janrain_capture_logout);
});';
  }

  if (!empty($janrain_capture_optional['backplane_js_path'])
    && !empty($janrain_capture_optional['backplane_server'])
    && !empty($janrain_capture_optional['backplane_bus_name'])) {
    $scripts['inline'][] = '(function() {
  Backplane(CAPTURE.bp_ready);
  Backplane.init({
    serverBaseURL: "' . $janrain_capture_optional['backplane_server'] . '",
    busName: "' . $janrain_capture_optional['backplane_bus_name'] . '"
  });
})();';
  }

  if (isset($_SESSION['janrain_capture_password_recover']) && $_SESSION['janrain_capture_password_recover'] == true) {
    $scripts['inline'][] = 'jQuery(function($) {
  $.fancybox({
    type: "iframe",
    href: "' . url('janrain_capture/profile', array('absolute' => true, 'query' => array('method' => '_change_password'))) . '",
    padding: 0,
    scrolling: "no",
    autoScale: true,
    width: 666,
    autoDimensions: false
  });
});';
    $_SESSION['janrain_capture_password_recover'] = false;
  }

  $final_scripts = module_invoke_all('janrain_capture_add_js', $scripts);
  $final_styles = module_invoke_all('janrain_capture_add_css', $styles);

  if (is_array($final_scripts) && !empty($final_scripts))
    $scripts = $final_scripts;
  if (is_array($final_styles) && !empty($final_styles))
    $styles = $final_styles;

  if (isset($scripts['module']) && is_array($scripts['module'])) {
    foreach ($scripts['module'] as $s) {
      drupal_add_js($s, 'module', 'footer');
    }
  }
  if (isset($scripts['inline']) && is_array($scripts['inline'])) {
    foreach ($scripts['inline'] as $s) {
      drupal_add_js($s, 'inline', 'footer');
    }
  }
  if (is_array($styles)) {
    foreach ($styles as $s) {
      drupal_add_css($s);
    }
  }
}

/**
 * Implementation of hook_footer()
 */
function janrain_capture_ui_footer() {
  $janrain_capture_main = variable_get('janrain_capture_main', array());
  $janrain_capture_optional = variable_get('janrain_capture_optional', array());
  
  $scripts = '<script src="https://'
    . (!empty($janrain_capture_optional['captureui_address']) ? $janrain_capture_optional['captureui_address'] : $janrain_capture_main['capture_address'])
    . '/cdn/javascripts/capture_client.js" type="text/javascript"></script>';
  if (!empty($janrain_capture_optional['capture_sso_address'])) {
    $scripts .= '<script src="https://' . $janrain_capture_optional['capture_sso_address'] . '/sso.js" type="text/javascript"></script>';
  }
  if (!empty($janrain_capture_optional['backplane_js_path'])) {
    $scripts .= '<script src="' . $janrain_capture_optional['backplane_js_path'] . '" type="text/javascript"></script>';
  }
  return $scripts;
}

/**
 * Implementation of hook_form_alter()
 */
function janrain_capture_ui_form_user_profile_form_alter(&$form, $form_state) {
  global $user;

  if ($user->uid == $form['#uid']) {
    $form['account'] = array(
      '#type' => 'fieldset',
      '#title' => t('My Account'),
      '#collapsible' => true,
      '#collapsed' => false
    );
    $form['account']['description'] = array(
      '#type' => 'markup',
      '#value' => '<div class="form-item">
                    <a class="iframe fancy janrain_capture_anchor" href="' . url('janrain_capture/profile', array('absolute' => true)) . '">Edit Profile</a>
                </div>'
    );
  }
}

/**
 * Implementation of hook_menu_alter()
 */
function janrain_capture_ui_menu_alter(&$items) {
  $items['user/register']['access callback'] = 'user_access';
  $items['user/register']['access arguments'] = array('administer users');

  $items['user/password']['access callback'] = 'user_access';
  $items['user/password']['access arguments'] = array('administer users');
}

/**
 * Implementation of hook_block()
 */
function janrain_capture_ui_block($op = 'list', $delta = 0, $edit = array()) {
  global $user;

  $content = '';
  if ($user->uid) {
    $content.= $_SESSION['janrain_capture_access_token'] ? '<li><a class="iframe fancy janrain_capture_anchor" href="' . url('janrain_capture/profile', array('absolute' => true)) . '">View / Edit Profile</a></li>' : '';
    $content.= '<li><a href="' . url('logout') . '" onclick="janrain_capture_logout">Log out</a></li>';
  }
  else {
    $content.= '<li><a class="iframe fancy janrain_capture_anchor janrain_capture_signin" href="' . CAPTURE_LOGIN_URL . '">Register / Sign In</a></li>';
  }

  switch ($op) {
    case 'list':
      $block[0]['info'] = t('Janrain Capture');
      break;
    case 'view':
      $block['subject'] = t('Janrain Capture');
      $block['content'] = '<ul class="menu">' . $content . '</ul>';
      break;
  }
  return $block;
}
